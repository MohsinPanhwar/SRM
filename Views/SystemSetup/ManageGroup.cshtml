@model SRM.Models.ViewModels.ManageGroupVM

@{
    ViewBag.Title = "Manage Groups";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class=" setup-container">
    <div class="section-header">
        <h2>Manage Groups</h2>
        @* Replaced inline styles with action-row class *@
    <div class="action-row">
        <input type="text" id="newGroupName" placeholder="Enter Group Name" required />
        @Html.DropDownList("newManagerName", Model.AgentList, "-- Select Manager --", new { @id = "newManagerName" })
        @Html.DropDownList("newProgramName", Model.ProgramList, "-- Select Program --", new { @id = "newProgramName" })
        <button id="addGroupBtn" class="setup-btn-green">+ Add Group</button>
    </div>
    </div>

    <table class="crud-table">
        <thead>
            <tr>
                <th>Program Name</th>
                <th>Group Name</th>
                <th>Manager PNo</th>
                <th>No. of Members</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="groupTableBody">
            @foreach (var grp in Model.ExistingGroups)
            {
                <tr data-id="@grp.GroupId">
                    <td class="program-name">@grp.ProgramName</td>
                    <td class="group-name">@grp.GroupName</td>
                    <td class="manager-name">@grp.Manager</td>
                    <td class="members-count">@grp.MembersCount</td>
                    <td class="actions-cell">
                        <div class="icon-btn-group">
                            <button class="edit-btn" title="Edit">✏️</button>
                            <button class="delete-btn" title="Delete">❌</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
    @section scripts {
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
$(function() {

    // 1. ADD NEW GROUP
    $('#addGroupBtn').click(function() {
        var data = {
            GroupId: 0,
            ProgramName: $('#newProgramName').val(),
            GroupName: $('#newGroupName').val().trim(),
            Manager: $('#newManagerName').val()
        };

        if (!data.ProgramName || !data.GroupName) {
            alert('Program and Group Name are required');
            return;
        }

        $.post('@Url.Action("SaveGroup","Group")', data, function(res) {
            if (res.success) {
                // For Add, reload is often cleanest to get the new ID and row formatting
                location.reload();
            } else {
                alert("Error: " + res.message);
            }
        });
    });

    // 2. INLINE EDIT
    $(document).on('click', '.edit-btn', function() {
        var row = $(this).closest('tr');

        // Store current values in data attributes for Cancel logic
        row.data('old-program', row.find('.program-name').text().trim());
        row.data('old-group', row.find('.group-name').text().trim());
        row.data('old-manager', row.find('.manager-name').text().trim());

        var program = row.data('old-program');
        var group = row.data('old-group');
        var manager = row.data('old-manager');

        row.find('.program-name').html(`<input type="text" class="edit-input" value="${program}" />`);
        row.find('.group-name').html(`<input type="text" class="edit-input" value="${group}" />`);
        row.find('.manager-name').html(`<input type="text" class="edit-input" value="${manager}" />`);

        row.find('.actions-cell').html(`
            <button class="save-btn">💾</button>
            <button class="cancel-btn">🚫</button>
        `);
    });

    // 3. SAVE INLINE EDIT
    $(document).on('click', '.save-btn', function() {
        var row = $(this).closest('tr');
        var id = row.data('id');

        var data = {
            GroupId: id,
            ProgramName: row.find('.program-name input').val().trim(),
            GroupName: row.find('.group-name input').val().trim(),
            Manager: row.find('.manager-name input').val().trim()
        };

        if (!data.ProgramName || !data.GroupName) {
            alert('Required fields cannot be empty');
            return;
        }

        $.post('@Url.Action("SaveGroup","Group")', data, function(res) {
            if (res.success) {
                // Update UI without reload
                revertRow(row, data.ProgramName, data.GroupName, data.Manager);
                alert("Group updated successfully!");
            } else {
                // Show duplication error
                alert("Error: " + res.message);
            }
        });
    });

    // 4. CANCEL EDIT
    $(document).on('click', '.cancel-btn', function() {
        var row = $(this).closest('tr');
        revertRow(row, row.data('old-program'), row.data('old-group'), row.data('old-manager'));
    });

    // 5. DELETE
    $(document).on('click', '.delete-btn', function() {
        var row = $(this).closest('tr');
        if (confirm('Delete this group?')) {
            $.post('@Url.Action("DeleteGroup","Group")', { id: row.data('id') }, function(res) {
                if (res.success) row.remove();
                else alert(res.message);
            });
        }
    });

    // Helper to switch back to read-only mode
    function revertRow(row, program, group, manager) {
        row.find('.program-name').text(program);
        row.find('.group-name').text(group);
        row.find('.manager-name').text(manager);
        row.find('.actions-cell').html(`
            <div class="icon-btn-group">
                <button class="edit-btn" title="Edit">✏️</button>
                <button class="delete-btn" title="Delete">❌</button>
            </div>
        `);
    }
});
        </script>
    }
