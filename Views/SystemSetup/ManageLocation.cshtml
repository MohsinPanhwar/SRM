@model IEnumerable<SRM.Models.Location>

@{
    ViewBag.Title = "Manage Locations";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // We removed 'var programs' because we are getting the ID from the switcher session.
}

<div class="setup-container">
    <div class="section-header">
        <h2>Manage Work Areas</h2>

        <div class="action-row">
            <input type="text" id="newLocationName" placeholder="Enter work area name" />
            <button id="addLocationBtn" class="setup-btn-green">+ Add Work Area</button>
        </div>

        <p style="font-size: 11px; color: #666; margin-top: 5px;">
            Adding to: <strong>@(Session["AgentProgramName"] ?? "Global / All Programs")</strong>
        </p>
    </div>

    <table class="crud-table">
        <thead>
            <tr>
                <th>Work Area</th>
                <th style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody id="locationTableBody">
            @foreach (var loc in Model)
            {
                <tr data-id="@loc.sno">
                    <td class="location-name">@loc.Location_Description</td>
                    <td class="actions-cell">
                        <div class="icon-btn-group">
                            <button type="button" class="edit-btn" title="Edit">✏️</button>
                            <button type="button" class="delete-btn" title="Delete">❌</button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div> @* Closed the container properly here *@

@section scripts {
    <script>
        $(function() {
            // 1. TOAST HELPER
            function showToast(message, type = 'success') {
                const id = 'toast-' + Date.now();
                const icon = type === 'success' ? '✅' : '🗑️';
                const toastClass = type === 'success' ? 'toast-success' : 'toast-error';

                const html = `
                    <div id="${id}" class="toast-msg ${toastClass}" style="display:none; position:relative; left:-40px; opacity:0;">
                        <span style="margin-right:10px;">${icon}</span>
                        <span>${message}</span>
                    </div>`;

                if ($('#notification-area').length === 0) {
                    $('body').append('<div id="notification-area"></div>');
                }

                $('#notification-area').append(html);

                $(`#${id}`).show().animate({ left: "0px", opacity: "1" }, 300)
                           .delay(1000)
                           .fadeOut(function () { $(this).remove(); });
            }

            // 2. ADD LOCATION
            $('#addLocationBtn').click(function() {
                var name = $('#newLocationName').val().trim();
                if (!name) {
                    showToast('Enter work area name', 'error');
                    return;
                }

                // Controller will grab Program_id from Session["AgentProgramId"]
                $.post('@Url.Action("SaveLocation", "Location")', { Location_Description: name }, function(res) {
                    if (res.success) {
                        showToast("Work Area added!", "success");

                        // Reloading is best practice here to ensure the list matches the current Switcher context
                        setTimeout(function() { location.reload(); }, 800);
                    } else {
                        showToast(res.message, "error");
                    }
                });
            });

            // 3. SAVE EDITS
            $(document).on('click', '.save-btn', function() {
                var row = $(this).closest('tr');
                var id = row.data('id');
                var newName = row.find('.edit-input').val().trim();

                if (!newName) {
                    showToast('Name cannot be empty', 'error');
                    return;
                }

                $.post('@Url.Action("SaveLocation", "Location")', { sno: id, Location_Description: newName }, function(res) {
                    if (res.success) {
                        revertRow(row, res.location.Location_Description);
                        showToast("Work Area updated!");
                        row.css('background-color', '#e6fffa').animate({backgroundColor: 'transparent'}, 1000);
                    } else {
                        showToast(res.message, "error");
                    }
                });
            });

            // 4. DELETE LOCATION
            $(document).on('click', '.delete-btn', function() {
                var row = $(this).closest('tr');
                if (confirm('Delete this work area?')) {
                    $.post('@Url.Action("DeleteLocation", "Location")', { id: row.data('id') }, function(res) {
                        if (res.success) {
                            row.css('background-color', '#fff5f5').fadeOut(600, function () {
                                $(this).remove();
                                showToast("Work Area deleted", "error");
                            });
                        } else {
                            showToast(res.message, "error");
                        }
                    });
                }
            });

            // --- UI HELPERS ---
            $(document).on('click', '.edit-btn', function() {
                var row = $(this).closest('tr');
                var oldName = row.find('.location-name').text().trim();
                row.data('old-name', oldName);

                row.find('.location-name').html(`<input type="text" class="edit-input" value="${oldName}" style="width:100%"/>`);
                row.find('.actions-cell').html(`
                    <div class="icon-btn-group">
                        <button class="save-btn">💾</button>
                        <button class="cancel-btn">🚫</button>
                    </div>
                `);
            });

            $(document).on('click', '.cancel-btn', function() {
                var row = $(this).closest('tr');
                revertRow(row, row.data('old-name'));
            });

            function revertRow(row, name) {
                row.find('.location-name').text(name);
                row.find('.actions-cell').html(`
                    <div class="icon-btn-group">
                        <button class="edit-btn">✏️</button>
                        <button class="delete-btn">❌</button>
                    </div>
                `);
            }
        });
    </script>
}