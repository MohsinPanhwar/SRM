@using System.Security.Claims
@model IEnumerable<SRM.Models.Agent>

@{
    ViewBag.Title = "Manage User";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var privs = Session["UserPrivileges"] as SRM.Models.Privilege;
    bool isAdmin = false;

    // 1. Check Super Admin Status
    if (Session["IsAdmin"] != null)
    {
        var adminSession = Session["IsAdmin"].ToString();
        isAdmin = (adminSession == "Y" || adminSession == "True" || adminSession == "true");
    }

    // 2. STRICTOR CHECK: Check the specific Privilege table flag
    // We check if privs is not null AND the boolean column 'CanAddEditGroups' is true
    bool hasUserPrivilege = privs != null && privs.CanAddEditEngineer == true;

    // 3. Final Permission
    bool canModify = isAdmin || hasUserPrivilege;
}
<div class="setup-container">
    <div class="section-header">
        <h2>Manage Users</h2>
        @if (canModify)
        {
            <div class="action-row">
                <input type="text" id="PnoSearch" class="form-control" placeholder="Enter PNo (e.g. 10254)" />
                <button type="button" id="btnLookup" class="setup-btn-green">🔍 Find Record</button>
                <button type="button" id="btnToggleAction" class="setup-btn-green">Add New User</button>
            </div>
        }
        </div>
        
    <div id="userListSection">
        <table class="crud-table" id="allUsersTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name / PNo</th>
                    <th>Last Login</th>
                    <th>Email / Mobile</th>
                    <th style="text-align:center;">Status</th>
                    @if (canModify)
                    {
                        <th>Actions</th>
                    }
                    </tr>
            </thead>
            <tbody id="allUsersTableBody">
                @foreach (var u in Model)
                {
                    var statusColor = (u.Status == "A" || u.Status == "Y") ? "#28a745" : "#dc3545";
                    var statusText = (u.Status == "A" || u.Status == "Y") ? "Active" : "Inactive";
                <tr data-pno="@u.Pno">
                    <td><img src="/images/default.png" width="40" height="40" style="border-radius:50%;" /></td>
                    <td class="td-name-pno"><strong>@u.Name</strong><br /><span class="pno-text">@u.Pno</span></td>
                    <td>@(u.LastLoginDateTime?.ToString("g") ?? "-")</td>
                    <td class="td-email-mobile"><span class="email-text">@u.Email</span><br /><span class="mobile-text">@u.Mobile</span></td>
                    <td class="td-status" style="text-align:center; color:@statusColor; font-weight:bold;">@statusText</td>
                    @if (canModify)
                    {
                        <td>
                            <button type="button" class="btn-select-user edit-btn" data-pno="@u.Pno">✏️</button>
                            <button type="button" class="btn-delete-user delete-btn" data-pno="@u.Pno">❌</button>
                        </td>
                    }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Form Submission now handled via AJAX in Scripts *@
    <div id="userDetailsForm" style="display:none; margin-top: 20px;">
        <form id="manageUserForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Pno" id="MainHiddenPno" />
            <input type="hidden" id="IsNewUserFlag" name="IsNewUser" value="false" />
            <input type="hidden" name="IsAdministrator" id="HiddenIsAdministrator" value="N" />

            <div class="form-row">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="Name" id="EditName" class="form-control" required />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="Email" id="EditEmail" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="text" name="Mobile" id="EditMobile" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Mobile Operator</label>
                    <select id="MobileOperator" name="MobileOperator" class="form-control">
                        <option value="">-- Select Operator --</option>
                        @foreach (var op in ViewBag.Operators)
                        {
                            <option value="@op">@op</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>User Type</label>
                    <div class="radio-group">
                        <input type="radio" id="typeIndiv" name="UserType" value="U"> Individual
                        <input type="radio" id="typeGroup" name="UserType" value="G"> Group
                    </div>
                </div>
                <div class="form-group">
                    <label>User Group</label>
                    <select id="GroupDropdown" name="GId" class="form-control">
                        <option value="">-- Select Group --</option>
                        @foreach (var g in (List<SelectListItem>)ViewBag.GroupList)
                        {
                            <option value="@g.Value">@g.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Work Area</label>
                    <select id="EditWorkArea" name="WorkArea" class="form-control">
                        <option value="">-- Select Work Area --</option>
                        @foreach (var wa in ViewBag.WorkAreas)
                        {
                            <option value="@wa">@wa</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Program Name</label>
                    <select id="EditProgramId" name="ProgramId" class="form-control">
                        <option value="">-- Select Program --</option>
                        @foreach (var p in (List<SelectListItem>)ViewBag.Programs)
                        {
                            <option value="@p.Value">@p.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>User Role</label>
                    @Html.DropDownList("RoleId", (SelectList)ViewBag.RoleList, "-- Select Role --", new { @class = "form-control", id = "EditRoleId" })
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div class="radio-group">
                        <input type="radio" id="statusActive" name="Status" value="A"> <span style="color:green">Active</span>
                        <input type="radio" id="statusInactive" name="Status" value="I"> <span style="color:red">Inactive</span>
                    </div>
                </div>
            </div>

            <div class="form-row" style="margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">💾 Save Changes</button>
                <button type="button" id="btnShowPass" class="btn btn-warning" style="flex: 1;">🔑 Reset Password</button>
            </div>
        </form>
    </div>

    <div id="passwordFields" style="display:none; margin-top: 20px; padding: 20px; border: 1px solid #ffeeba; background: #fffaf0; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">Reset Password</h4>
        <form id="changePassForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Pno" id="PasswordResetPno" />

            <div class="form-group" style="margin-bottom: 15px;">
                <label>New Password</label>
                <input type="password" name="newPassword" placeholder="Enter new password" class="form-control" required />
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label>Confirm Password</label>
                <input type="password" name="confirmPassword" placeholder="Confirm new password" class="form-control" required />
            </div>

            <button type="submit" class="setup-btn-green" style="width: 100%;">Update Password</button>
        </form>
    </div>
</div>

@section scripts {
    <script>
$(document).ready(function () {

    // 1. Toast Helper
    function showToast(message, type = 'success') {
        const id = 'toast-' + Date.now();
        const icon = type === 'success' ? '✅' : '🗑️';
        const html = `<div id="${id}" class="toast-msg ${type === 'success' ? 'toast-success' : 'toast-error'}" style="display:none; position:relative; left:-40px; opacity:0;">
                        <span style="margin-right:10px;">${icon}</span>
                        <span>${message}</span>
                      </div>`;
        if ($('#notification-area').length === 0) $('body').append('<div id="notification-area"></div>');
        $('#notification-area').append(html);
        $(`#${id}`).show().animate({ left: "0px", opacity: "1" }, 300).delay(1000).fadeOut(function () { $(this).remove(); });
    }

    // 2. Centralized Toggle Function
    function toggleView(showForm, isNewUser = false) {
        if (showForm) {
            $('#userListSection').hide();
            $('#userDetailsForm').fadeIn();
            $('#btnToggleAction').text('Back to List');
            $('#IsNewUserFlag').val(isNewUser ? "true" : "false");

            if (isNewUser) {
                $('#manageUserForm')[0].reset();
                $('#MainHiddenPno').val($('#PnoSearch').val().trim());
                $('#typeIndiv').prop('checked', true).trigger('change');
            }
        } else {
            $('#userDetailsForm, #passwordFields').hide();
            $('#userListSection').fadeIn();
            $('#btnToggleAction').text('Add New User').removeClass('btn-secondary').addClass('setup-btn-green');
        }
    }

    // 3. Check if role is "Admin" and set IsAdministrator accordingly
    function updateAdminStatus() {
        var selectedRoleText = $('#EditRoleId option:selected').text().trim().toLowerCase();
        if (selectedRoleText.includes('admin')) {
            $('#HiddenIsAdministrator').val('Y');
        } else {
            $('#HiddenIsAdministrator').val('N');
        }
    }

    // 4. Listen for role dropdown changes
    $(document).on('change', '#EditRoleId', function() {
        updateAdminStatus();
    });

    // 5. Save / Add User Submission
    $('#manageUserForm').submit(function (e) {
        e.preventDefault();
        updateAdminStatus();
        const formData = $(this).serialize();
        const isNew = $('#IsNewUserFlag').val() === "true";
        const pno = $('#MainHiddenPno').val();
        const name = $('#EditName').val();
        const email = $('#EditEmail').val();
        const mobile = $('#EditMobile').val();
        const status = $('input[name="Status"]:checked').val();
        const statusText = (status === "A" || status === "Y") ? "Active" : "Inactive";
        const statusColor = (status === "A" || status === "Y") ? "#28a745" : "#dc3545";
        const isAdmin = $('#HiddenIsAdministrator').val();
        const adminBadge = isAdmin === "Y" ? "✅ Yes" : "❌ No";
        const adminColor = isAdmin === "Y" ? "#28a745" : "#dc3545";

        $.post('@Url.Action("ManageUser", "User")', formData, function (res) {
            if (res.success) {
                showToast(isNew ? "User Created!" : "User Updated!");

                if (isNew) {
                    // Create New Row
                    const newRow = `<tr data-pno="${pno}">
                        <td><img src="/images/default.png" width="40" height="40" style="border-radius:50%;" /></td>
                        <td class="td-name-pno"><strong>${name}</strong><br />${pno}</td>
                        <td>Just now</td>
                        <td class="td-email-mobile">${email}<br />${mobile}</td>
                        <td class="td-status" style="text-align:center; color:${statusColor}; font-weight:bold;">${statusText}</td>
                        <td class="td-admin" style="text-align:center; color:${adminColor}; font-weight:bold;">${adminBadge}</td>
                        <td>
                            <button type="button" class="btn-select-user edit-btn" data-pno="${pno}">✏️</button>
                            <button type="button" class="btn-delete-user delete-btn" data-pno="${pno}">❌</button>
                        </td>
                    </tr>`;
                    $('#allUsersTableBody').prepend(newRow);
                } else {
                    // Update Existing Row
                    const $row = $(`tr[data-pno="${pno}"]`);
                    $row.find('.td-name-pno strong').text(name);
                    $row.find('.td-email-mobile').html(`${email}<br />${mobile}`);
                    $row.find('.td-status').text(statusText).css('color', statusColor);
                    $row.find('.td-admin').text(adminBadge).css('color', adminColor);
                    $row.css('background-color', '#e6fffa').animate({backgroundColor: 'transparent'}, 1000);
                }
                toggleView(false);
            } else {
                showToast(res.message, "error");
            }
        });
    });

    // 6. Reset Password AJAX
    $('#changePassForm').submit(function(e){
        e.preventDefault();
        $.post('@Url.Action("ChangePassword", "User")', $(this).serialize(), function(res){
            if(res.success) {
                showToast("Password Updated!");
                $('#passwordFields').slideUp();
            } else showToast(res.message, "error");
        });
    });

    // 7. Duplicate Check & Toggle
    $('#btnToggleAction').click(function () {
        if ($('#userDetailsForm').is(':visible')) {
            toggleView(false);
        } else {
            var pVal = $('#PnoSearch').val().trim();
            if (!pVal) { alert("Enter PNo first."); return; }
            if ($(`tr[data-pno="${pVal}"]`).length > 0) {
                alert("User with PNo " + pVal + " already exists.");
                return;
            }
            toggleView(true, true);
        }
    });

    // 8. Delete Logic
    $(document).on('click', '.btn-delete-user', function() {
        var pno = $(this).data('pno');
        var $row = $(this).closest('tr');
        if (confirm("Confirm deletion of user " + pno + "?")) {
            $.post('@Url.Action("DeleteUser", "User")', { pno: pno }, function(res) {
                if(res.success) {
                    $row.fadeOut(function() { $(this).remove(); });
                    showToast("User deleted", "error");
                } else alert(res.message);
            });
        }
    });

    // Other UI Hooks
    $(document).on('change', 'input[name="UserType"]', function () {
        const isGroup = $('#typeGroup').is(':checked');
        $('#GroupDropdown').prop('disabled', !isGroup).css('background-color', isGroup ? '#fff' : '#eee');
    });

    $(document).on('click', '.btn-select-user', function() {
        $('#PnoSearch').val($(this).data('pno'));
        $('#btnLookup').trigger('click');
    });

    $('#btnLookup').click(function () {
        var pVal = $('#PnoSearch').val().trim();
        if (!pVal) return;
        $.get('@Url.Action("GetUserByPno", "User")', { pno: pVal }, function (res) {
            if (res.success) {
                $('#MainHiddenPno, #PasswordResetPno').val(pVal);
                $('#EditName').val(res.data.Name);
                $('#EditEmail').val(res.data.Email);
                $('#EditMobile').val(res.data.Mobile);
                $('#MobileOperator').val(res.data.MobileOperator);
                $('#EditWorkArea').val(res.data.WorkArea);
                $('#EditRoleId').val(res.data.RoleId);
                $('#EditProgramId').val(res.data.ProgramId);
                $('#HiddenIsAdministrator').val(res.data.IsAdministrator);
                if (res.data.UserType === "G") {
                    $('#typeGroup').prop('checked', true);
                    $('#GroupDropdown').prop('disabled', false).val(res.data.Gid).css('background-color', '#fff');
                } else {
                    $('#typeIndiv').prop('checked', true);
                    $('#GroupDropdown').prop('disabled', true).val('').css('background-color', '#eee');
                }
                if (res.data.Status === "A" || res.data.Status === "Y") $('#statusActive').prop('checked', true);
                else $('#statusInactive').prop('checked', true);

                toggleView(true, false);
            } else alert(res.message);
        });
    });

    $('#btnShowPass').click(function () { $('#passwordFields').slideToggle(); });
});
    </script>
}