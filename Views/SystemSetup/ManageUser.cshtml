@using System.Security.Claims
@model IEnumerable<SRM.Models.Agent>

@{
    ViewBag.Title = "Manage User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .role-group-header {
        transition: background-color 0.3s ease;
        background-color: #f8f9fa;
        font-weight: bold;
    }

        .role-group-header td {
            padding: 12px !important;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

    
</style>

<div class="setup-container fade-in-up">
    <div class="section-header">
        <h2>Manage Users</h2>
        <div class="action-row">
            <input type="text" id="PnoSearch" class="form-control" placeholder="Enter PNo (e.g. 51959)" />
            <button type="button" id="btnLookup" class="setup-btn-green">🔍 Find Record</button>
            <button type="button" id="btnToggleAction" class="setup-btn-green">Add New User</button>
        </div>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
        <div style="display:flex; align-items:center; gap:8px;">
            <label class="switch" style="margin:0;">
                <input type="checkbox" id="toggleActiveOnly" checked>
                <span class="slider round"></span>
            </label>
            <span style="font-size:0.9rem; font-weight:500;">Show active users only</span>
        </div>
    </div>

    <div id="userListSection">
        <table class="crud-table" id="allUsersTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name / PNo</th>
                    <th>Last Login</th>
                    <th>Email / Mobile</th>
                    <th style="text-align:center;">Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="allUsersTableBody">
                @{
                    int currentRoleId = -1;
                    var rolesSource = (IEnumerable<SRM.Models.Role>)ViewBag.RoleListSource;
                }
                @foreach (var u in Model)
                {
                    if (u.RoleId != currentRoleId)
                    {
                        currentRoleId = u.RoleId ?? 0;
                        var roleDisplayName = rolesSource.FirstOrDefault(r => r.Role_Id == currentRoleId)?.Role_Name ?? "General Users";

                        <tr class="role-group-header">
                            <td colspan="6" style="text-align:center;">
                                👤 @roleDisplayName
                            </td>
                        </tr>
                    }

                    var statusColor = (u.Status == "A" || u.Status == "Y") ? "#28a745" : "#dc3545";
                    var statusText = (u.Status == "A" || u.Status == "Y") ? "Active" : "Inactive";

                    <tr data-pno="@u.Pno">
                        <td style="width:60px; text-align:center; vertical-align:middle;">
                            <img src="https://systemsupport.piac.com.pk/admin/AgentImages/@(u.Pno).jpg"
                                 width="60" height="60"
                                 style="border-radius:50%; border: 1px solid #ddd; display:block; margin:auto;"
                                 onerror="this.outerHTML='<div style=\'width:60px;height:60px;border-radius:50%;background:#white;color:white;display:flex;align-items:center;justify-content:center;font-size:1.3rem;margin:auto;\'>👤</div>'"                        </td>
                        <td class="td-name-pno"><strong>@u.Name</strong><br /><small class="text-muted">@u.Pno</small></td>
                        <td>
                            <span style="font-size: 0.85rem;">@(u.LastLoginDateTime?.ToString("g") ?? "-")</span><br />
                            <small class="text-muted" style="font-size: 0.75rem;">@u.LastLoginIp</small>
                        </td>
                        <td class="td-email-mobile">
                            <span style="font-size: 0.85rem;">@u.Email</span><br />
                            <span style="font-size: 0.85rem;">@u.Mobile</span>
                        </td>
                        <td class="td-status" style="text-align:center; color:@statusColor; font-weight:bold;">@statusText</td>
                        <td>
                            <button type="button" class="btn-select-user edit-btn" data-pno="@u.Pno">✏️</button>
                            <button type="button" class="btn-delete-user delete-btn" data-pno="@u.Pno">❌</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Form Section *@
    <div id="userDetailsForm" style="display:none; margin-top: 20px;">
        <form id="manageUserForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Pno" id="MainHiddenPno" />
            <input type="hidden" id="IsNewUserFlag" name="IsNewUser" value="false" />
            <input type="hidden" name="IsAdministrator" id="HiddenIsAdministrator" value="N" />

            <div class="form-row">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="Name" id="EditName" class="form-control" required />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="Email" id="EditEmail" class="form-control" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="text" name="Mobile" id="EditMobile" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Mobile Operator</label>
                    <select id="MobileOperator" name="MobileOperator" class="form-control">
                        <option value="">-- Select Operator --</option>
                        @foreach (var op in ViewBag.Operators)
                        {
                            <option value="@op">@op</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>User Type</label>
                    <div class="radio-group">
                        <input type="radio" id="typeIndiv" name="UserType" value="U"> Individual
                        <input type="radio" id="typeGroup" name="UserType" value="G"> Group
                    </div>
                </div>
                <div class="form-group">
                    <label>User Group</label>
                    <select id="GroupDropdown" name="GId" class="form-control">
                        <option value="">-- Select Group --</option>
                        @foreach (var g in (List<SelectListItem>)ViewBag.GroupList)
                        {
                            <option value="@g.Value">@g.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Work Area</label>
                    <select id="EditWorkArea" name="WorkArea" class="form-control">
                        <option value="">-- Select Work Area --</option>
                        @foreach (var wa in ViewBag.WorkAreas)
                        {
                            <option value="@wa">@wa</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Program Name</label>
                    <select id="EditProgramId" name="ProgramId" class="form-control">
                        <option value="">-- Select Program --</option>
                        @foreach (var p in (List<SelectListItem>)ViewBag.AllPrograms)
                        {
                            <option value="@p.Value">@p.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>User Role</label>
                    @Html.DropDownList("RoleId", (SelectList)ViewBag.RoleList, "-- Select Role --", new { @class = "form-control", id = "EditRoleId" })
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div class="radio-group">
                        <input type="radio" id="statusActive" name="Status" value="A"> <span style="color:green">Active</span>
                        <input type="radio" id="statusInactive" name="Status" value="I"> <span style="color:red">Inactive</span>
                    </div>
                </div>
            </div>

            <div class="form-row" style="margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">💾 Save Changes</button>
                <button type="button" id="btnShowPass" class="btn btn-warning" style="flex: 1;">🔑 Reset Password</button>
            </div>
        </form>
    </div>

    @* Password Section *@
    <div id="passwordFields" style="display:none; margin-top: 20px; padding: 20px; border: 1px solid #ffeeba; background: #fffaf0; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">Reset Password</h4>
        <form id="changePassForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Pno" id="PasswordResetPno" />
            <div class="form-group" style="margin-bottom: 15px;">
                <label>New Password</label>
                <input type="password" name="newPassword" placeholder="Enter new password" class="form-control" required />
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Confirm Password</label>
                <input type="password" name="confirmPassword" placeholder="Confirm new password" class="form-control" required />
            </div>
            <button type="submit" class="setup-btn-green" style="width: 100%;">Update Password</button>
        </form>
    </div>
</div>

@section scripts {
    <script>
    $(document).ready(function () {

        

        const pendingToast = sessionStorage.getItem("pendingToast");
        if (pendingToast) {
            const toastData = JSON.parse(pendingToast);
            showGlobalToast(toastData.message, toastData.type);
            sessionStorage.removeItem("pendingToast");
        }

        function toggleView(showForm, isNewUser = false) {
            if (showForm) {
                $('#userListSection').hide();
                $('#userDetailsForm').fadeIn();
                $('#btnToggleAction').text('Back to List');
                $('#IsNewUserFlag').val(isNewUser ? "true" : "false");
                if (isNewUser) {
                    $('#manageUserForm')[0].reset();
                    $('#MainHiddenPno').val($('#PnoSearch').val().trim());
                    $('#typeIndiv').prop('checked', true).trigger('change');
                    $('#passwordFields').hide();
                }
            } else {
                $('#userDetailsForm, #passwordFields').hide();
                $('#userListSection').fadeIn();
                $('#btnToggleAction').text('Add New User').removeClass('btn-secondary').addClass('setup-btn-green');
            }
        }

        function updateAdminStatus() {
            var selectedRoleText = $('#EditRoleId option:selected').text().trim().toLowerCase();
            $('#HiddenIsAdministrator').val(selectedRoleText.includes('admin') ? 'Y' : 'N');
        }

        $(document).on('change', '#EditRoleId', updateAdminStatus);

        $('#manageUserForm').submit(function (e) {
            e.preventDefault();
            updateAdminStatus();
            const $submitBtn = $(this).find('button[type="submit"]');
            $submitBtn.prop('disabled', true).text('Processing...');

            $.post('@Url.Action("ManageUser", "User")', $(this).serialize(), function (res) {
                if (res.success) {
                    sessionStorage.setItem("pendingToast", JSON.stringify({
                        message: $('#IsNewUserFlag').val() === "true" ? "User Created!" : "Changes Saved!",
                        type: "success"
                    }));
                    location.reload();
                } else {
                    showGlobalToast(res.message, "error");
                    $submitBtn.prop('disabled', false).text('💾 Save Changes');
                }
            });
        });

       $('#changePassForm').submit(function(e){
            e.preventDefault();
            $.post('@Url.Action("ChangePassword", "User")', $(this).serialize(), function(res){
                if(res.success) {
                    showGlobalToast("Password Updated!", "success");  // changed
                    $('#passwordFields').slideUp();
                    $('#changePassForm')[0].reset();
                } else showGlobalToast(res.message, "error");  // changed
            });
        });

        $('#btnToggleAction').click(function () {
            if ($('#userDetailsForm').is(':visible')) {
                toggleView(false);
            } else {
                var pVal = $('#PnoSearch').val().trim();
                if (!pVal) { alert("Enter PNo first."); return; }
                if ($(`tr[data-pno="${pVal}"]`).length > 0) {
                    alert("User already exists in the list.");
                    return;
                }
                toggleView(true, true);
            }
        });

        $(document).on('click', '.btn-delete-user', function() {
            var pno = $(this).data('pno');
            if (confirm("Permanently delete user " + pno + "?")) {
                $.post('@Url.Action("DeleteUser", "User")', { pno: pno }, function(res) {
                    if(res.success) {
                        sessionStorage.setItem("pendingToast", JSON.stringify({ message: "User Deleted", type: "error" }));
                        location.reload();
                    } else alert(res.message);
                });
            }
        });

        $(document).on('change', 'input[name="UserType"]', function () {
            const isGroup = $('#typeGroup').is(':checked');
            $('#GroupDropdown').prop('disabled', !isGroup).css('background-color', isGroup ? '#fff' : '#eee');
        });

        $(document).on('click', '.btn-select-user', function() {
            $('#PnoSearch').val($(this).data('pno'));
            $('#btnLookup').trigger('click');
        });

        $('#btnLookup').click(function () {
            var pVal = $('#PnoSearch').val().trim();
            if (!pVal) return;
            $.get('@Url.Action("GetUserByPno", "User")', { pno: pVal }, function (res) {
                if (res.success) {
                    $('#MainHiddenPno, #PasswordResetPno').val(pVal);
                    $('#EditName').val(res.data.Name);
                    $('#EditEmail').val(res.data.Email);
                    $('#EditMobile').val(res.data.Mobile);
                    $('#MobileOperator').val(res.data.MobileOperator);
                    $('#EditWorkArea').val(res.data.WorkArea);
                    $('#EditRoleId').val(res.data.RoleId);
                    $('#EditProgramId').val(res.data.ProgramId);
                    $('#HiddenIsAdministrator').val(res.data.IsAdministrator);
                    if (res.data.UserType === "G") {
                        $('#typeGroup').prop('checked', true);
                        $('#GroupDropdown').prop('disabled', false).val(res.data.Gid).css('background-color', '#fff');
                    } else {
                        $('#typeIndiv').prop('checked', true);
                        $('#GroupDropdown').prop('disabled', true).val('').css('background-color', '#eee');
                    }
                    if (res.data.Status === "A" || res.data.Status === "Y") $('#statusActive').prop('checked', true);
                    else $('#statusInactive').prop('checked', true);
                    toggleView(true, false);
                } else alert(res.message);
            });
        });

        $('#btnShowPass').click(function () { $('#passwordFields').slideToggle(); });

        // Filter Logic
        $('#toggleActiveOnly').on('change', function () {
            const activeOnly = $(this).is(':checked');

            // Filter user rows
            $('#allUsersTableBody tr').not('.role-group-header').each(function () {
                const statusText = $(this).find('.td-status').text().trim();
                if (activeOnly) {
                    $(this).toggle(statusText === 'Active');
                } else {
                    $(this).show();
                }
            });

            // Handle group headers (hide if no visible children)
            $('#allUsersTableBody tr.role-group-header').each(function () {
                const $header = $(this);
                const hasVisibleRows = $header.nextUntil('.role-group-header').filter(':visible').length > 0;
                $header.toggle(hasVisibleRows);
            });
        });

        // Initialize Filter
        $('#toggleActiveOnly').trigger('change');
    });
    </script>
}