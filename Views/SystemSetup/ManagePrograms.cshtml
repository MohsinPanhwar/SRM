@model List<SRM.Models.Program_Setup>

@{
    ViewBag.Title = "Manage Programs";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class=" setup-container">
    <div class="section-header">
        <h2>Manage Programs</h2>
        @* Added action-row for consistent 38px height and spacing *@
        <div class="action-row">
            <input type="text" id="newProgramName" placeholder="Enter program name" />
            <button id="addProgramBtn" class="setup-btn-green">+ Add Program</button>
        </div>
    </div>

    <table class="crud-table">
        <thead>
            <tr>
                <th>Program Name</th>
                @* Actions column width is now controlled by the CSS actions-cell class *@
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="programTableBody">
            @foreach (var program in Model)
            {
                <tr data-id="@program.Program_Id">
                    <td class="program-name">@program.Program_Name</td>
                    <td class="actions-cell">
                        <div class="icon-btn-group">
                            <button class="edit-btn" title="Edit">✏️</button>
                            <button class="delete-btn" title="Delete">❌</button>
                            </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
    @section scripts {
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
$(function() {

    // ADD PROGRAM (With Duplication Handling)
    $('#addProgramBtn').click(function() {
        var name = $('#newProgramName').val().trim();
        if (!name) {
            alert('Enter program name');
            return;
        }

        // Note: URL points to "Add" in "Program" controller
        $.post('@Url.Action("Add", "Program")', { programName: name }, function(res) {
            if (res.success) {
                $('#programTableBody').append(`
                    <tr data-id="${res.program.Program_Id}">
                        <td class="program-name">${res.program.Program_Name}</td>
                        <td class="actions-cell">
                            <button class="edit-btn">✏️</button>
                            <button class="delete-btn">❌</button>
                        </td>
                    </tr>
                `);
                $('#newProgramName').val('');
                alert("Program added successfully!");
            } else {
                // This captures the "already exists" message from your C# logic
                alert("Error: " + res.message);
            }
        });
    });

    // DELETE PROGRAM
    $(document).on('click', '.delete-btn', function() {
        var row = $(this).closest('tr');
        var id = row.data('id');

        if (confirm('Delete this program?')) {
            $.post('@Url.Action("Delete", "Program")', { id: id }, function(res) {
                if (res.success) {
                    row.remove();
                } else {
                    alert(res.message);
                }
            });
        }
    });

    // EDIT PROGRAM
    $(document).on('click', '.edit-btn', function() {
        var row = $(this).closest('tr');
        var nameCell = row.find('.program-name');
        var oldName = nameCell.text().trim();

        // Store old name in data attribute in case user cancels or error occurs
        row.data('old-name', oldName);

        nameCell.html(`<input type="text" class="edit-input" value="${oldName}" style="width:100%" />`);

        row.find('.actions-cell').html(`
            <button class="save-btn">💾</button>
            <button class="cancel-btn">🚫</button>
        `);
    });

    // SAVE EDITS (With Duplication Handling)
    $(document).on('click', '.save-btn', function() {
        var row = $(this).closest('tr');
        var id = row.data('id');
        var newName = row.find('.edit-input').val().trim();
        var oldName = row.data('old-name');

        if (!newName) {
            alert('Name cannot be empty');
            return;
        }

        // Optimization: If name hasn't changed, just revert to text view
        if (newName.toLowerCase() === oldName.toLowerCase()) {
            revertRow(row, oldName);
            return;
        }

        $.post('@Url.Action("Edit", "Program")', { id: id, programName: newName }, function(res) {
            if (res.success) {
                revertRow(row, res.program.Program_Name);
            } else {
                // This captures duplication errors during editing
                alert("Error: " + res.message);
            }
        });
    });

    // CANCEL EDIT
    $(document).on('click', '.cancel-btn', function() {
        var row = $(this).closest('tr');
        var oldName = row.data('old-name');
        revertRow(row, oldName);
    });

    // Helper function to revert row to standard view
    function revertRow(row, name) {
        row.find('.program-name').text(name);
        row.find('.actions-cell').html(`
            <button class="edit-btn">✏️</button>
            <button class="delete-btn">❌</button>
        `);
    }

});        </script>
    }
