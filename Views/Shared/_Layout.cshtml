@using SRM.Helpers
@{/*
    var privs = Session["UserPrivileges"] as SRM.Models.Privilege;
    bool isAdmin = false;

    // 1. Check Super Admin Status
    if (Session["IsAdmin"] != null)
    {
        var adminSession = Session["IsAdmin"].ToString();
        isAdmin = (adminSession == "Y" || adminSession == "True" || adminSession == "true");
    }

    // 2. STRICTOR CHECK: Check the specific Privilege table flag
    // We check if privs is not null AND the boolean column 'CanAddEditGroups' is true
    bool canLogRequest = isAdmin || (privs != null && privs.CanLogNewRequest == true);
    bool canViewRequest = isAdmin || (privs != null && privs.CanOnlyViewAny == true);
    bool canSendSms = isAdmin || (privs != null && privs.CanSendSMS == true);
    bool canSendPassword = isAdmin || (privs != null && privs.CanSendPassword == true);
    bool canManage = isAdmin || (privs != null && privs.CanAddEditGroups == true);
  */
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Service Request Manager</title>
    <link rel="stylesheet" href="~/Content/site.css">
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <a href="/Home/home" class="logo">SRM</a>
            <div class="nav-items">


                <div class="dropdown">
                    @if (PrivilegeHelper.HasPrivilege("MG") || PrivilegeHelper.IsSuperAdmin())
                    {
                        <button class="dropbtn">System Setup</button>
                        <div class="dropdown-content">
                            <a href="@Url.Action("ManagePrograms", "Program")">Manage Program</a>
                            <a href="@Url.Action("ManageUser", "User")">Manage User</a>
                            <a href="@Url.Action("ManageGroup", "Group")">Manage Group</a>
                            <a href="@Url.Action("ManageLocation", "Location")">Manage Work Area</a>
                            <a href="@Url.Action("ManageRole", "Role")">Manage Role</a>
                            <a href="@Url.Action("MessageBoard", "Message")">Message Board</a>
                        </div>
                    }
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Asset Issuance</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("Index", "InventoryCategory")">View All Categories</a>
                        <a href="@Url.Action("Index", "InventoryBrand")">View All Brands</a>
                        <a href="@Url.Action("Issuance", "AssetIssuance")">Issuance</a>
                        <a href="@Url.Action("IssuedAssetHistory", "AssetIssuance")">View All Asset</a>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Service Request</button>
                    <div class="dropdown-content">
                        @if (PrivilegeHelper.HasPrivilege("LNR"))
                        {
                            <a href="@Url.Action("LogNewRequest", "NewRequest")">Log new request</a>
                        }
                        @if (PrivilegeHelper.HasPrivilege("VR"))
                        {
                            <a href="@Url.Action("ViewAllRequests", "ViewAllRequests", new { status = "All" })">Show all requests</a>
                        }
                        @if (PrivilegeHelper.HasPrivilege("SMS"))
                        {
                            <a href="@Url.Action("SendSmsToEngineer", "ServiceRequest")">Send SMS</a>
                        }
                        @if (PrivilegeHelper.HasPrivilege("SPWD"))
                        {
                            <a href="@Url.Action("SendPasswordToAgents", "ServiceRequest")">Send Password to Agents</a>
                        }
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Hardware Dispatch</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("LogNewHardware", "HardwareDispatch")">Log New Hardware Dispatch</a>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Log Reports</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("DailyNOCReports", "LogReport")">View Daily Log Reports</a>
                        <a href="@Url.Action("ManageReportCategory", "LogReport")">Add new description</a>
                        <a href="@Url.Action("LogNew", "LogReport")">Log new report</a>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Incident Management</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("LogNewIncident", "Incident")">Log new Incident</a>
                        <a href="@Url.Action("Index", "Incident")">Show all Incident</a>
                        <a href="@Url.Action("Search", "Incident")">Search</a>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">Activity Management</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("LogNewActivity", "Activity")">Log new Activity</a>
                        <a href="@Url.Action("Index", "Activity")">Show All Activities</a>
                    </div>
                </div>

                <div class="dropdown">
                    <button class="dropbtn">MIS</button>
                    <div class="dropdown-content">
                        <a href="@Url.Action("Overall", "Mis")">MIS</a>
                        <a href="@Url.Action("Dashboards", "Mis")">Dashboards</a>
                    </div>
                </div>

            </div>
        </div>

        <button class="logout-button" onclick="window.location.href='@Url.Action("Logout","Account")'">Logout</button>

    </nav>

    @* --- SUPER ADMIN PROGRAM SWITCHER (OVERLAYING HERO BANNER) --- *@
    @if (SRM.Helpers.PrivilegeHelper.IsSuperAdmin())
    {
        using (var db = new SRM.Data.AppDbContext())
        {
            var programsList = db.Programs
                                 .Select(p => new { p.Program_Id, p.Program_Name })
                                 .OrderBy(p => p.Program_Id)
                                 .ToList();

            <div class="program-switcher-wrapper"
                 style="position: absolute; right: 20px; top: 62px; z-index: 999; height: 0; width: auto;">
                @* top: 70px assumes your navbar is roughly 60-70px high. Adjust this to match your navbar height. *@

                @using (Html.BeginForm("SetGlobalProgram", "Admin", FormMethod.Post, new { id = "globalProgramForm", style = "margin: 0;" }))
                {
                    <div class="switcher-container" style="display: flex; align-items: center; background: #1b4d3e; border: 1px solid #ffd700; border-radius: 4px; padding: 4px 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        <span class="switcher-label" style="color: #ffd700; font-size: 10px; font-weight: bold; margin-right: 8px; white-space: nowrap;">VIEWING AS:</span>
                        <select name="programId" onchange="document.getElementById('globalProgramForm').submit();"
                                style="background: transparent; color: white; border: none; font-size: 12px; outline: none; cursor: pointer; padding: 2px 0;">
                            <option value="" style="background: #1b4d3e;">-- All Programs --</option>
                            @foreach (var p in programsList)
                            {
                                <option value="@p.Program_Id"
                                        style="background: #1b4d3e;"
                                        @(Session["AgentProgramId"]?.ToString() == p.Program_Id.ToString() ? "selected" : "")>
                                    @p.Program_Name
                                </option>
                            }
                        </select>
                    </div>
                }
            </div>
        }
    }
    <!-- Body placeholder -->
    <div class="main-container">
        @RenderBody()
    </div>

    <!-- Footer -->
    <footer>
        &copy; 2026 Service Request Manager | All Rights Reserved
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    @RenderSection("scripts", required: false)
</body>
<script>
    // 1. Define the function in the global scope so ALL pages can see it
    function showGlobalToast(message, type = 'success') {
        const icon = type === 'success' ? '✅' : '❌';
        const toastClass = type === 'success' ? 'toast-success' : 'toast-error';

        const html = `<div class="toast-msg ${toastClass}">
                        <span style="margin-right:10px;">${icon}</span>
                        <span>${message}</span>
                      </div>`;

        // Ensure container exists
        if ($('#notification-area').length === 0) {
            $('body').append('<div id="notification-area"></div>');
        }

        const $toast = $(html);
        $('#notification-area').append($toast);

        // Slide In -> Wait -> Slide Out
        $toast.show().animate({ left: "0px", opacity: "1" }, 300)
              .delay(1000) // 5 seconds is much more user-friendly
              .animate({ left: "-40px", opacity: "0" }, 300, function () {
                  $(this).remove();
              });
    }

    $(document).ready(function () {
        // 2. Listen for Server-Side messages (TempData)
        @if (TempData["Success"] != null) {
            <text>showGlobalToast("@TempData["Success"]", "success");</text>
        }
        @if (TempData["Error"] != null) {
            <text>showGlobalToast("@TempData["Error"]", "error");</text>
        }
    });
</script>
</html>
