@model SRM.Models.AllRequestsViewModel
@{
    ViewBag.Title = "View All Requests";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="setup-container">
    <div class="section-header">
        <h2>View All Requests</h2>
        <div class="record-count">
            <strong>@Model.RequestList.Count</strong> record(s) found
        </div>
    </div>

    <div class="search-area">
        @using (Html.BeginForm("ViewAllRequests", "ViewAllRequests", FormMethod.Get))
        {
            <div style="display:flex; justify-content: space-between; align-items: flex-start;">
                <table class="filter-table">
                    <tr>
                        <td><strong>Search By</strong></td>
                        <td>
                            @Html.DropDownList("searchBy", new SelectList(new[] { "RequestID", "Summary" }), new { @class = "form-control" })
                        </td>
                        <td><input type="text" name="searchText" value="@Model.SearchText" placeholder="Enter keyword..." /></td>
                    </tr>
                    @* --- Added Status Filter Row --- *@
                    <tr>
                        <td><strong>Status Filter</strong></td>
                        <td>
                            <select name="statusFilter" class="form-control" onchange="this.form.submit();">
                                <option value="All" @(Model.StatusFilter == "All" ? "selected" : "")>-- All Statuses --</option>
                                <option value="Q" @(Model.StatusFilter == "Q" ? "selected" : "")>Queued 👥</option>
                                <option value="F" @(Model.StatusFilter == "F" ? "selected" : "")>Forwarded ➡️</option>
                                <option value="R" @(Model.StatusFilter == "R" ? "selected" : "")>Resolved ✅</option>
                                <option value="C" @(Model.StatusFilter == "C" ? "selected" : "")>Closed ✔️</option>
                            </select>
                        </td>
                        <td style="color: #666; font-size: 0.85em;">
                            Currently viewing: <strong>@Model.StatusFilter</strong>
                        </td>
                    </tr>
                    @* ------------------------------ *@
                    <tr>
                        <td><strong>From</strong></td>
                        <td><input type="date" name="fromDate" value="@Model.FromDate.ToString("yyyy-MM-dd")" /></td>
                        <td rowspan="2" style="vertical-align:bottom;">
                            <button type="submit" class="setup-btn-green">Search & Filter</button>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>To</strong></td>
                        <td><input type="date" name="toDate" value="@Model.ToDate.ToString("yyyy-MM-dd")" /></td>
                    </tr>
                </table>

                <table class="status-card">
                    <thead><tr><th colspan="3">Overall Status Summary</th></tr></thead>
                    <tbody>
                        <tr><td>Queue</td><td align="center">👥</td><td>@Model.QueueCount</td></tr>
                        <tr><td>Forwarded</td><td align="center">➡️</td><td>@Model.ForwardedCount</td></tr>
                        <tr><td>Resolved</td><td align="center">✅</td><td>@Model.ResolvedCount</td></tr>
                        <tr><td>Closed</td><td align="center">✔️</td><td>@Model.ClosedCount</td></tr>
                        <tr style="font-weight:bold; background:#f9f9f9;"><td>Total</td><td></td><td>@Model.TotalCount</td></tr>
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div style="text-align:center; margin-bottom:15px; color: #666;">
        <small>Showing results from <strong>@Model.FromDate.ToString("dd-MMM-yyyy")</strong> to <strong>@Model.ToDate.ToString("dd-MMM-yyyy")</strong></small>
    </div>

    <table class="crud-table">
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Subject</th>
                <th>Request Date</th>
                <th style="white-space: nowrap;">Forward To</th>
                <th>Site/Location</th>
                <th style="text-align:center;">Status</th>
                <th>Pending</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.RequestList)
            {
                <tr>
                    <td style="text-align:left; padding-left: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <a href="@Url.Action("Details", new { id = item.RequestID })"
                               style="color: #2e7d57; font-weight: bold; font-size: 1.05em;">
                                @item.RequestID
                            </a>
                            @if (item.Priority == 1)
                            {
                                <div style="display: flex; align-items: center; justify-content: center;
                        background-color: #ff0000; color: white;
                        width: 20px; height: 20px; border-radius: 50%;
                        font-weight: bold; font-size: 14px; flex-shrink: 0;"
                                     title="Critical Priority!">
                                    !
                                </div>
                            }
                            else
                            {
                                <div style="width: 20px;"></div>
                            }
                        </div>
                    </td>
                    <td>@item.ReqSummary</td>
                    <td>@item.RequestDate.Value.ToString("dd-MMM-yyyy hh:mm tt")</td>
                    <td>@(string.IsNullOrEmpty(item.Forward_To) ? "---" : item.Forward_To)</td>
                    <td>@item.Location</td>
                    <td align="center">
                        @if (item.status == "Q")
                        {<span title="Queue">👥</span> }
                        else if (item.status == "F")
                        { <span title="Forwarded">➡️</span> }
                        else if (item.status == "R")
                        { <span title="Resolved">✅</span> }
                        else
                        { <span title="Closed">✔️</span>}
                    </td>
                    <td>
                        @{
                            var diff = DateTime.Now - item.RequestDate.Value;
                            if (item.status == "C" || item.status == "R")
                            { <span>---</span> }
                            else
                            { @($"{diff.Days}d {diff.Hours}h");
                            }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
@section scripts {
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // This calls the GLOBAL function in your _Layout
                showGlobalToast("Request ID " + text + " copied to clipboard!", "success");
            });
        }

        $(document).ready(function() {
            // If the user arrived here with 0 results, the Layout toast will
            // already handle the TempData["Error"] from the controller.
        });
    </script>
}
