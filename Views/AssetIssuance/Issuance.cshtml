@model SRM.Models.ViewModels.AssetIssuanceVM
@{
    ViewBag.Title = "Asset Issuance";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="setup-container">

    <div class="section-header">
        <h2>Asset Issuance &amp; Management</h2>
    </div>

    <!-- ═══ SEARCH BAR ═══ -->
    <div class="action-row" style="margin-bottom:20px; padding:15px; background:#fdfdfd; border:1px solid #eee; border-radius:4px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
            <div style="display:flex; gap:10px; align-items:center;">
                <label class="control-label"><strong>Reported P-no:</strong></label>
                <input type="text" id="pno" class="form-control" style="width:200px;" placeholder="Enter PNO..." />
                <button id="btnSearch" class="setup-btn-green">🔍 Search &amp; Load</button>
            </div>
            <button type="button" id="btnShowAssetForm" class="setup-btn-green" style="background-color:#2c3e50;">
                ➕ Assign Asset to User
            </button>
        </div>
    </div>

    <!-- ═══ USER INFORMATION ═══ -->
    <div class="form-section-header">User Information</div>

    <div class="grid-container">
        <div class="grid-label">Reported Employee ID</div>
        <div class="grid-input"><input type="text" id="empId" class="form-control" /></div>

        <div class="grid-label">Employee Name</div>
        <div class="grid-input"><input type="text" id="name" class="form-control" /></div>

        <div class="grid-label">Designation</div>
        <div class="grid-input"><input type="text" id="designation" class="form-control" /></div>

        <div class="grid-label">Department</div>
        <div class="grid-input"><input type="text" id="department" class="form-control" /></div>

        <div class="grid-label">Email</div>
        <div class="grid-input"><input type="text" id="email" class="form-control" /></div>

        <div class="grid-label">Mobile No</div>
        <div class="grid-input"><input type="text" id="mobile" class="form-control" /></div>

        <div class="grid-label">Phone-Ext</div>
        <div class="grid-input">
            @Html.TextBoxFor(m => m.Office_Ext, new { @class = "form-control", id = "phoneExt" })
        </div>

        <div class="grid-label">Room No *</div>
        <div class="grid-input">
            @Html.TextBoxFor(m => m.RoomNo, new { @class = "form-control", id = "roomNo" })
        </div>

        <div class="grid-label">IP-Address</div>
        <div class="grid-input">
            @Html.TextBoxFor(m => m.IpAddress, new { @class = "form-control", id = "ipAddress" })
        </div>

        <div class="grid-label">Location *</div>
        <div class="grid-input">
            @Html.DropDownListFor(m => m.Location,
                Model.LocationList,
                new { @class = "form-control", id = "location" })
        </div>
    </div>

    <div class="action-footer" style="text-align:right; padding:10px 0 20px 0;">
        <button type="button" id="btnSaveUser" class="setup-btn-green" style="font-size:12px; padding:5px 15px;">
            💾 Save/Update User Info
        </button>
    </div>

    <!-- ═══ NEW ASSET ASSIGNMENT (collapsible) ═══ -->
    <div id="assetFormContainer" style="display:none; border:2px solid #1e4d2b; padding:20px; border-radius:10px; background:#fcfcfc; margin-bottom:30px;">

        <div class="form-section-header" style="background-color:#1e4d2b;">New Asset Assignment</div>

        <div class="grid-container">

            <div class="grid-label">Asset Type</div>
            <div class="grid-input">
                <div style="display:flex; align-items:center; gap:8px;">
                    @Html.DropDownListFor(m => m.Issue.CategoryID, Model.CategoryList, "-- Select --", new { @class = "form-control", style = "flex:1; height:45px !important;" })
                    <a href="@Url.Action("ViewCategory","Category")" style="text-decoration:none;">
                        <button type="button" title="Add New Category"
                                style="background:linear-gradient(135deg,#0f2f27 0%,#1b4d3e 50%,#2e7d57 100%); color:white; border:none; border-radius:50%; width:35px; height:35px; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                            +
                        </button>
                    </a>
                </div>
            </div>

            <div class="grid-label">Tel. Ext</div>
            <div class="grid-input">
                <input type="text" id="telExt" class="form-control" placeholder="For Telephone Issuance" />
            </div>

            <div class="grid-label">Make / Brand</div>
            <div class="grid-input">
                <div style="display:flex; align-items:center; gap:8px;">
                    @Html.DropDownListFor(m => m.Issue.BrandID, Model.BrandList, "-- Select --", new { @class = "form-control", style = "flex:1; height:45px !important;" })
                    <a href="@Url.Action("I","InventoryBrand")" style="text-decoration:none;">
                        <button type="button" title="Add New Brand"
                                style="background:linear-gradient(135deg,#0f2f27 0%,#1b4d3e 50%,#2e7d57 100%); color:white; border:none; border-radius:50%; width:35px; height:35px; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                            +
                        </button>
                    </a>
                </div>
            </div>
            <div class="grid-label">Model Number</div>
            <div class="grid-input">
                @Html.TextBoxFor(m => m.Issue.modelNumber, new { @class = "form-control", placeholder = "Enter model ID" })
            </div>

            <div class="grid-label">Serial Number</div>
            <div class="grid-input">
                @Html.TextBoxFor(m => m.Issue.serialNumber, new { @class = "form-control", placeholder = "Enter serial number" })
            </div>

            <div class="grid-label">Asset Tag Number</div>
            <div class="grid-input">
                @Html.TextBoxFor(m => m.Issue.assetTag, new { @class = "form-control", placeholder = "Enter tag number" })
            </div>

            <div class="grid-label">Condition</div>
            <div class="grid-input" style="grid-column: span 3;">
                <div class="radio-group" style="display:flex; gap:15px;">
                    <label><input type="radio" name="condition" value="New" /> New</label>
                    <label><input type="radio" name="condition" value="Used" /> Used</label>
                    <label><input type="radio" name="condition" value="Refurbished" /> Refurbished</label>
                </div>
            </div>

            <div class="grid-label">Accessories Included</div>
            <div class="grid-input" style="grid-column: span 3;">
                <div class="checkbox-group" style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
                    <label><input type="checkbox" name="accessories" value="Mouse" /> Mouse</label>
                    <label><input type="checkbox" name="accessories" value="WirelessMouse" /> Wireless Mouse</label>
                    <label><input type="checkbox" name="accessories" value="Keyboard" /> Keyboard</label>
                    <label><input type="checkbox" name="accessories" value="WirelessKeyboard" /> Wireless Keyboard</label>
                    <label><input type="checkbox" name="accessories" value="PowerAdapter" /> Power Adapter</label>
                    <label><input type="checkbox" name="accessories" value="LaptopBag" /> Laptop Bag</label>
                    <label><input type="checkbox" name="accessories" value="LCD" /> LCD</label>
                    <label><input type="checkbox" name="accessories" value="Headset" /> Headset</label>
                </div>
            </div>

            <div class="grid-label">Other Accessories</div>
            <div class="grid-input" style="grid-column: span 3;">
                <input type="text" id="otherAccessories" class="form-control" placeholder="Charger, cables, etc." />
            </div>

            <div class="grid-label">Other Serial No</div>
            <div class="grid-input" style="grid-column: span 3;">
                <textarea id="otherSerialNumber" class="form-control" style="height:50px;"></textarea>
            </div>

            <div class="grid-label">Warranty Status</div>
            <div class="grid-input">
                <input type="date" id="warrantyStatus" class="form-control" />
            </div>

            <div class="grid-label">Previous User PNO</div>
            <div class="grid-input">
                <input type="text" id="previousUserPno" class="form-control" />
            </div>

            <div class="grid-label">Issue Date</div>
            <div class="grid-input">
                <input type="date" id="issueDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
            </div>

            <div class="grid-label">Purchase Order No</div>
            <div class="grid-input">
                <input type="text" id="purchaseOrderNo" class="form-control" />
            </div>

            <div class="grid-label">Gatepass No</div>
            <div class="grid-input">
                <input type="text" id="gatepassNo" class="form-control" />
            </div>

            <div class="grid-label">Station</div>
            <div class="grid-input">
                @Html.DropDownListFor(m => m.Location, Model.LocationList, new { @class = "form-control", id = "assetLocation" })
            </div>

            <div class="grid-label">Remarks</div>
            <div class="grid-input" style="grid-column: span 3;">
                @Html.TextAreaFor(m => m.Issue.remarks, new { @class = "form-control", style = "height:60px;" })
            </div>

        </div>

        <div class="action-footer" style="text-align:center; margin-top:20px; display:flex; justify-content:center; gap:10px;">
            <button type="button" id="btnSubmitFinal" class="setup-btn-green" style="background-color:#1e4d2b; padding:10px 30px;">
                ✔ Confirm Assignment
            </button>
            <button type="button" onclick="$('#assetFormContainer').slideUp();" class="setup-btn-green" style="background-color:#666;">
                Cancel
            </button>
        </div>
    </div>

    <!-- ═══ ASSIGNED ASSET LIST ═══ -->

    <table class="crud-table">
        <thead>
            <tr>
                <th>Ref No</th>
                <th>Issue Date</th>
                <th>Item Name</th>
                <th>Brand</th>
                <th>Accessories</th>
                <th width="200">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.RecentAssets != null && Model.RecentAssets.Any())
            {
                foreach (var item in Model.RecentAssets)
                {
                    <tr>
                        <td>@item.sno</td>
                        <td>@item.IssueDate.ToString("dd-MMM-yyyy")</td>
                        <td>@item.CategoryName</td>
                        <td>@item.BrandName</td>
                        <td>@item.accessories</td>
                        <td class="actions-cell" style="white-space:nowrap;">
                            <a href="@Url.Action("Details","AssetIssuance", new { id = item.sno })"
                               title="View Details"
                               style="color:#1a6b3c; font-size:26px; text-decoration:none; margin-right:16px;">
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            <a href="javascript:void(0)"
                               onclick="editAsset(@item.sno)"
                               title="Edit"
                               style="color:#1a6b3c; font-size:26px; text-decoration:none; margin-right:16px;">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <button class="btn-print-qr"
                                    data-id="@item.sno"
                                    data-serial="@item.serialNumber"
                                    title="Print QR Label"
                                    style="background:none; border:none; cursor:pointer; color:#1a6b3c; font-size:26px; padding:0;">
                                <i class="bi bi-qr-code-scan"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" style="text-align:center; padding:20px;">No assets found for this user.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section scripts {
    <script>

        function editAsset(id) {
            $('#assetFormContainer').slideDown(500);

            $.get('/AssetIssuance/GetAssetById', { id: id }, function (res) {
                if (res.success) {
                    $('#Issue_CategoryID').val(res.data.CategoryID);
                    $('#Issue_BrandID').val(res.data.BrandID);
                    $('#Issue_modelNumber').val(res.data.modelNumber);
                    $('#Issue_serialNumber').val(res.data.serialNumber);
                    $('#Issue_assetTag').val(res.data.assetTag);
                    $('#issueDate').val(res.issueDate);
                    $('#assetLocation').val(res.data.Location_ID);
                    $('#Issue_remarks').val(res.data.remarks);
                    $('#empId').val(res.data.Issued_to_PNO);
                    $('#telExt').val(res.data.TelExt);

                    $('.checkbox-group input').prop('checked', false);
                    if (res.data.accessories) {
                        res.data.accessories.split(', ').forEach(function (val) {
                            $('.checkbox-group input[value="' + val + '"]').prop('checked', true);
                        });
                    }

                    $('#btnSubmitFinal')
                        .text('Update Asset Information')
                        .css('background-color', '#d35400');

                    $('html, body').animate({ scrollTop: $('#assetFormContainer').offset().top - 20 }, 500);
                    window.editingAssetId = id;

                    showGlobalToast('Asset loaded for editing.', 'success');
                } else {
                    showGlobalToast('Could not retrieve asset data.', 'error');
                }
            });
        }

        $(document).ready(function () {

            // 1. TOGGLE ASSET FORM
            $('#btnShowAssetForm').click(function () {
                if (!$('#empId').val()) {
                    showGlobalToast('Please search and load an employee first!', 'error');
                    return;
                }
                $('#assetFormContainer').slideToggle();
            });

            // 2. SEARCH EMPLOYEE
            $('#btnSearch').click(function () {
                var pno = $('#pno').val();
                if (!pno) { showGlobalToast('Please enter a PNO.', 'error'); return; }

                $.get('/AssetIssuance/GetEmployee', { pno: pno }, function (res) {
                    if (res.success) {
                        $('#empId').val(pno);
                        $('#name').val(res.name);
                        $('#designation').val(res.designation);
                        $('#department').val(res.department);
                        $('#email').val(res.email);
                        $('#mobile').val(res.mobile);
                        setEmployeeFieldsReadonly(true);
                        showGlobalToast('Employee loaded successfully.', 'success');
                    } else {
                        setEmployeeFieldsReadonly(false);
                        $('#empId,#name,#designation,#department,#email,#mobile').val('');
                        showGlobalToast('Employee not found.', 'error');
                    }
                });
            });

            function setEmployeeFieldsReadonly(isReadonly) {
                $('#empId,#name,#designation,#department,#email,#mobile').prop('readonly', isReadonly);
            }

            // 3. SAVE USER INFO
            $('#btnSaveUser').click(function () {
                var emp = {
                    Pno: $('#empId').val(),
                    Name: $('#name').val(),
                    Designation: $('#designation').val(),
                    Department: $('#department').val(),
                    Email: $('#email').val(),
                    Mobile: $('#mobile').val(),
                    Office_ext: $('#phoneExt').val(),
                    Ip_Address: $('#ipAddress').val(),
                    Roomno: $('#roomNo').val(),
                    Location: $('#location').val()
                };
                if (!emp.Pno) { showGlobalToast('PNO is required.', 'error'); return; }

                $.post('/AssetIssuance/SaveUser', emp, function (res) {
                    showGlobalToast(res.message, res.success ? 'success' : 'error');
                }).fail(function () {
                    showGlobalToast('Server error while saving user.', 'error');
                });
            });

            // 4. SUBMIT / UPDATE ASSET
            $('#btnSubmitFinal').click(function (e) {
                e.preventDefault();

                var selectedAcc = [];
                $('.checkbox-group input[type="checkbox"]:checked').each(function () {
                    selectedAcc.push($(this).val());
                });

                var assetData = {
                    sno: window.editingAssetId,
                    CategoryID: $('#Issue_CategoryID').val(),
                    BrandID: $('#Issue_BrandID').val(),
                    modelNumber: $('#Issue_modelNumber').val(),
                    serialNumber: $('#Issue_serialNumber').val(),
                    assetTag: $('#Issue_assetTag').val(),
                    condition: $('input[name="condition"]:checked').val(),
                    accessories: selectedAcc.join(', '),
                    other_accessories: $('#otherAccessories').val(),
                    otherserialNumber: $('#otherSerialNumber').val(),
                    warranty: $('#warrantyStatus').val(),
                    previousUser: $('#previousUserPno').val(),
                    IssueDate: $('#issueDate').val(),
                    ponum: $('#purchaseOrderNo').val(),
                    gatepass: $('#gatepassNo').val(),
                    Location_ID: $('#assetLocation').val(),
                    remarks: $('#Issue_remarks').val(),
                    TelExt: $('#telExt').val(),
                    Issued_to_PNO: $('#empId').val()
                };

                if (!assetData.serialNumber || !assetData.Issued_to_PNO) {
                    showGlobalToast('Serial Number and Employee PNO are required.', 'error');
                    return;
                }

                $.ajax({
                    url: '/AssetIssuance/SaveAsset',
                    type: 'POST',
                    data: { Issue: assetData },
                    success: function (res) {
                        if (res.success) {
                            showGlobalToast('Asset assigned successfully!', 'success');
                            window.editingAssetId = null;
                            setTimeout(function () { window.location.reload(); }, 1500);
                        } else {
                            showGlobalToast('Error: ' + res.message, 'error');
                        }
                    },
                    error: function () {
                        showGlobalToast('Communication failed. Check Network tab (F12).', 'error');
                    }
                });
            });
        });
    </script>
}